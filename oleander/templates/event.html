{% extends '_layout.html' %}
{% from '_macros.html' import form_errors, contact_box, button_link, small_contact %}


{% block title -%}
    {{- event.verbose_name }}{% if current_user.is_authenticated() %} - Oleander{% endif -%}
{%- endblock %}


{% block header %}
    {% if current_user.is_authenticated() %}{{ super() }}{% endif %}
{% endblock %}


{% block footer_contents %}
    {% if current_user.is_anonymous() %}
        <p>powered by {{ event.user.name }}'s {{ nav_link('events', 'Oleander') }}</p>
    {% endif %}
    {{ super() }}
{% endblock %}


{% block content %}
{% if current_user.is_authenticated() %}
<p class="breadcrumbs">
    <a href="{{ url_for('events') }}">Events</a> &raquo; {{ event.name }}
</p>
{% endif %}

<div class="event{% if event.is_cancelled %} cancelled{% endif %}">
<h1>{{ event.verbose_name }}</h1>

{% if current_user.is_authenticated() %}
<div class="action_area">
    <p>{{ button_link(url_for('edit_event', id=event.id), 'Edit event details') }}</p>
</div>
{% endif %}

<table>
    <tr>
        <th><label>When</label></th>
        <td>
            {% if event.starts_at %}
                {{ event.starts_at|datetime }}
            {% else %}
                unknown (yet)
            {% endif %}
        </td>
    </tr>
    <tr>
        <th><label>Where</label></th>
        <td>
            {% if event.venue %}
                {{ event.venue.name }} <small><a href="{{ event.venue.name|map_link }}" target="_blank">on map</a></small>
            {% else %}
                unknown (yet)
            {% endif %}
        </td>
    </tr>
    {% if event.description %}
    <tr>
        <th><label>What</label></th>
        <td>
            {{ event.description }}
        </td>
    </tr>
    {% endif %}
</table>

<h2>Attendance</h2>
<div class="attendance_group">
{% set going_contacts = event.contacts_maybe|list %}
{% set going_contacts_count = going_contacts|length %}

{% set maybe_contacts = event.contacts_maybe|list %}
{% set maybe_contacts_count = maybe_contacts|length %}

{% set declined_contacts = event.contacts_maybe|list %}
{% set declined_contacts_count = declined_contacts|length %}

{% if attendance_group == 'maybe' %}
    <nav>
        <ul>
            <li><a href="{{ url_for('event', id=event.id, attendance_group='going') }}">{{ going_contacts_count }} going</a></li>
            <li class="active"><h3>{{ maybe_contacts_count }} maybe</h3></li>
            {% if declined_contacts_count %}<li><a href="{{ url_for('event', id=event.id, attendance_group='declined') }}">{{ declined_contacts_count }} declined</a></li>{% endif %}
        </ul>
    </nav>

    {% if maybe_contacts %}
        <ul class="contacts_list">
            {% for contact in maybe_contacts %}
                <li>{{ contact_box(contact) }}</li>
            {% endfor %}
        </ul>
        <br class="cleaner">
    {% else %}
        <p>Nobody.</p>
    {% endif %}

{% elif attendance_group == 'declined' %}
    <nav>
        <ul>
            <li><a href="{{ url_for('event', id=event.id, attendance_group='going') }}">{{ going_contacts_count }} going</a></li>
            {% if maybe_contacts_count %}<li><a href="{{ url_for('event', id=event.id, attendance_group='maybe') }}">{{ maybe_contacts_count }} maybe</a></li>{% endif %}
            <li class="active"><h3>{{ declined_contacts_count }} declined</h3></li>
        </ul>
    </nav>

    {% if declined_contacts %}
        <ul class="contacts_list">
            {% for contact in declined_contacts %}
                <li>{{ contact_box(contact) }}</li>
            {% endfor %}
        </ul>
        <br class="cleaner">
    {% else %}
        <p>Nobody.</p>
    {% endif %}

{% else %}
    {% if going_contacts_count or maybe_contacts_count or declined_contacts_count %}
    <nav>
        <ul>
            <li class="active"><h3>{{ going_contacts_count }} going</h3></li>
            {% if maybe_contacts_count %}<li><a href="{{ url_for('event', id=event.id, attendance_group='maybe') }}">{{ maybe_contacts_count }} maybe</a></li>{% endif %}
            {% if declined_contacts_count %}<li><a href="{{ url_for('event', id=event.id, attendance_group='declined') }}">{{ declined_contacts_count }} declined</a></li>{% endif %}
        </ul>
    </nav>
    {% endif %}

    {% if current_user.is_authenticated() %}
    <div class="action_area">
        {% with invite_link = '#' %}
            {% if going_contacts %}
                <p>{{ button_link(invite_link, 'Invite more contacts') }}</p>
            {% else %}
                <p>{{ button_link(invite_link, 'Invite contacts') }}</p>
            {% endif %}
        {% endwith %}
    </div>
    {% endif %}

    {% if going_contacts %}
        <ul class="contacts_list">
            {% for contact in going_contacts %}
                <li>{{ contact_box(contact) }}</li>
            {% endfor %}
        </ul>
        <br class="cleaner">
    {% else %}
        <p>Nobody.</p>
    {% endif %}

{% endif %}
</div>

{% if current_user.is_authenticated() %}
<div class="action_area">
    <p>
    {% if event.is_cancelled %}
        {{ button_link(url_for('revive_event', id=event.id), 'Revive this event') }}
    {% else %}
        {{ button_link(url_for('cancel_event', id=event.id), 'Cancel this event') }}
    {% endif %}
    </p>
</div>
{% endif %}
</div>
{% endblock %}